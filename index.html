<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投票系统</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { color: #4CAF50; }
        .vote-option { margin: 10px 0; }
        .vote-option input { margin-right: 10px; }
        #vote-result { margin-top: 20px; }
        .reasons { margin-top: 20px; }
    </style>
</head>
<body>

    <h1>投票系统</h1>
    <p>请选择今天让你生气的畜生，并提供投票理由：</p>
    
    <form id="vote-form">
        <div class="vote-option">
            <input type="radio" name="vote" value="乔治" id="python"> 
            <label for="python">乔治</label>
        </div>
        <div class="vote-option">
            <input type="radio" name="vote" value="孟子" id="cpp">
            <label for="cpp">孟子</label>
        </div>
        <div class="vote-option">
            <input type="radio" name="vote" value="Hpv" id="js">
            <label for="js">Hpv</label>
        </div>

        <textarea id="reason" placeholder="请输入你的理由" rows="4" cols="50"></textarea><br><br>
        
        <button type="button" onclick="submitVote()">提交投票</button>
    </form>

    <div id="vote-result">
        <h3>投票结果：</h3>
        <p>乔治: <span id="python-result">0</span> 票</p>
        <p>孟子: <span id="cpp-result">0</span> 票</p>
        <p>Hpv: <span id="js-result">0</span> 票</p>
        <h4>总票数: <span id="total-votes">0</span> 票</h4>
    </div>

    <div class="reasons">
        <h3>投票理由：</h3>
        <div id="reasons-list"></div>
    </div>

    <script>
        // GitHub 仓库信息
        const repoOwner = 'zzquui';  // 你的 GitHub 用户名
        const repoName = 'fwr-cs';   // 你的 GitHub 仓库名
        const issueLabels = ['乔治', '孟子', 'Hpv']; // 3 个选项的标签

        // 获取每个 Issue 的评论数（即每个选项的票数）
        async function fetchIssues() {
            const votes = { "乔治": 0, "孟子": 0, "Hpv": 0 };

            // 获取每个 Issue 的评论数
            for (let label of issueLabels) {
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/issues?state=open&labels=${label}`);
                const issues = await response.json();
                const issue = issues[0]; // 获取第一个 Issue
                const comments = issue.comments || 0; // 获取评论数（即票数）
                votes[label] = comments;
            }

            // 更新页面显示
            displayVotes(votes);
        }

        // 显示投票结果
        function displayVotes(votes) {
            document.getElementById('python-result').textContent = votes.乔治 || 0;
            document.getElementById('cpp-result').textContent = votes.孟子 || 0;
            document.getElementById('js-result').textContent = votes.Hpv || 0;
            
            // 显示总票数
            const totalVotes = votes.乔治 + votes.孟子 + votes.Hpv;
            document.getElementById('total-votes').textContent = totalVotes;
        }

        // 提交投票并添加评论
        async function submitVote() {
            const selectedOption = document.querySelector('input[name="vote"]:checked');
            const reasonText = document.getElementById('reason').value;
            
            // 检查用户是否选择了投票选项和提供了理由
            if (!selectedOption || !reasonText) {
                alert('请选择一个选项并提供投票理由');
                return;
            }

            const vote = selectedOption.value;
            const reason = reasonText;  // 获取用户输入的理由

            // 获取对应选项的 Issue ID
            const issueId = await getIssueId(vote); // 根据选项获取对应的 Issue ID

            if (issueId) {
                // 在对应的 Issue 下添加评论
                await postComment(issueId, reason);
                alert('投票提交成功！');
                fetchIssues();  // 刷新票数
            }
        }

        // 获取对应投票选项的 Issue ID
        async function getIssueId(vote) {
            const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/issues?state=open&labels=${vote}`);
            const issues = await response.json();
            const issue = issues[0]; // 获取第一个 Issue
            return issue ? issue.id : null;
        }

        // 在 Issue 下添加评论
        async function postComment(issueId, comment) {
            const token = 'your_github_token';  // 你需要替换为 GitHub 的 Token
            const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/issues/${issueId}/comments`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    body: comment
                })
            });

            if (!response.ok) {
                alert('评论提交失败，请稍后再试');
            }
        }

        // 页面加载时获取投票数据
        fetchIssues();

    </script>

</body>
</html>
